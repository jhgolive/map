<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 맵/구글 맵</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8swteRAgf-r_tS_uncv_IWJKcGghanrY&libraries=geometry"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, marker, destinationMarker;
let geocoder, directionsService, directionsRenderer;
let lastPosition = null;

// ✅ 다크모드 스타일
const darkModeStyle = [
  { elementType: "geometry", stylers: [{ color: "#212121" }] },
  { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
  { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
  { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
  { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#757575" }] },
  { featureType: "poi", elementType: "geometry", stylers: [{ color: "#303030" }] },
  { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#181818" }] },
  { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#2c2c2c" }] },
  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#1c1c1c" }] },
  { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }] }
];

// ✅ 내 위치 마커
function createMarker(pos) {
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            url: "data:image/svg+xml;utf-8," + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40">
                  <polygon points="12,0 18,0 25,5 15,30 5,5" fill="red"/>
                </svg>`),
            scaledSize: new google.maps.Size(30, 40)
        }
    });
}

// ✅ 목적지 마커
function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);
    destinationMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            url: "data:image/svg+xml;utf-8," + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40">
                  <polygon points="12,0 18,0 25,5 15,30 5,5" fill="blue"/>
                </svg>`),
            scaledSize: new google.maps.Size(30, 40)
        }
    });
}

// ✅ 주소 오버레이 (상단)
class AddressOverlay extends google.maps.OverlayView {
    constructor(map) {
        super();
        this.map = map;
        this.div = null;
        this.text = "";
        this.setMap(map);
    }
    onAdd() {
        this.div = document.createElement("div");
        this.div.style.position = "absolute";
        this.div.style.padding = "5px 10px";
        this.div.style.background = "rgba(0,0,0,0.6)";
        this.div.style.color = "#fff";
        this.div.style.fontWeight = "bold";
        this.div.style.borderRadius = "5px";
        this.div.style.whiteSpace = "nowrap";
        this.div.style.zIndex = "9999";
        this.getPanes().floatPane.appendChild(this.div);
    }
    draw() {
        const mapDiv = this.getMap().getDiv();
        this.div.style.left = (mapDiv.offsetWidth / 2 - this.div.offsetWidth / 2) + "px";
        this.div.style.top = "10px";
    }
    setText(text) {
        this.text = text;
        if (this.div) this.div.innerText = this.text;
    }
    onRemove() {
        if (this.div) this.div.parentNode.removeChild(this.div);
    }
}

// ✅ 거리 오버레이 (하단)
class DistanceOverlay extends google.maps.OverlayView {
    constructor(map) {
        super();
        this.map = map;
        this.div = null;
        this.text = "";
        this.setMap(map);
    }
    onAdd() {
        this.div = document.createElement("div");
        this.div.style.position = "absolute";
        this.div.style.padding = "5px 10px";
        this.div.style.background = "rgba(0,102,255,0.8)";
        this.div.style.color = "#fff";
        this.div.style.fontWeight = "bold";
        this.div.style.borderRadius = "8px";
        this.div.style.whiteSpace = "nowrap";
        this.div.style.zIndex = "9999";
        this.getPanes().floatPane.appendChild(this.div);
    }
    draw() {
        const mapDiv = this.getMap().getDiv();
        this.div.style.left = (mapDiv.offsetWidth / 2 - this.div.offsetWidth / 2) + "px";
        this.div.style.top = (mapDiv.offsetHeight - this.div.offsetHeight - 10) + "px"; // 하단 10px
    }
    setText(text) {
        this.text = text;
        if (this.div) this.div.innerText = this.text;
    }
    onRemove() {
        if (this.div) this.div.parentNode.removeChild(this.div);
    }
}

// 오버레이 인스턴스
let addressOverlay, distanceOverlay;

// 거리 계산
function updateDistanceText(distanceMeters) {
    let text = distanceMeters >= 1000 ? (distanceMeters/1000).toFixed(2) + " km" : distanceMeters.toFixed(0) + " m";
    if (distanceOverlay) distanceOverlay.setText(text);
}

// 주소 업데이트
function updateAddress(lat, lng) {
    const latLng = new google.maps.LatLng(lat, lng);
    if (!addressOverlay) addressOverlay = new AddressOverlay(map);
    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === "OK" && results[0]) addressOverlay.setText(results[0].formatted_address);
        else addressOverlay.setText("주소를 가져올 수 없음");
    });
}

// 경로 그리기
function drawRealRoute(start, end) {
    directionsService.route({
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.TRANSIT
    }, (result, status) => {
        if(status==="OK") {
            directionsRenderer.setDirections(result);
            const dist = result.routes[0].legs[0].distance.value;
            updateDistanceText(dist);
        }
    });
}

window.onload = function() {
    const container = document.getElementById("map");
    map = new google.maps.Map(container, {
        center: {lat:37.5665,lng:126.9780},
        zoom:14,
        disableDefaultUI:true
    });

    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

    addressOverlay = new AddressOverlay(map);
    distanceOverlay = new DistanceOverlay(map);

    // 다크모드 구독
    const darkRef = ref(db, "location/settings/darkMode");
    onValue(darkRef, snapshot => {
        const enabled = snapshot.val();
        map.setOptions({ styles: enabled ? darkModeStyle : [] });
    });

    // 내 위치 구독
    const locRef = ref(db, "location/current");
    onValue(locRef, snapshot => {
        const data = snapshot.val();
        if(!data) return;
        const pos = {lat:data.lat,lng:data.lng};

        if(!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);

        if(data.level!==undefined) map.setZoom(20-data.level);
        if(data.mapSize!==undefined){
            container.style.width = data.mapSize+"px";
            container.style.height = data.mapSize+"px";
        }
        if(data.opacity!==undefined) container.style.opacity = data.opacity;
        if(data.borderRadius!==undefined) container.style.borderRadius = data.borderRadius+"px";

        updateAddress(pos.lat,pos.lng);

        if(destinationMarker){
            const destPos = destinationMarker.getPosition().toJSON();
            if(!lastPosition || google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(pos), new google.maps.LatLng(lastPosition))>5){
                    drawRealRoute(pos,destPos);
                    lastPosition = pos;
            }
        }
    });

    // 지도 클릭 → 목적지 설정/삭제
    map.addListener("click", e => {
        const destRef = ref(db,"location/destination");
        if(destinationMarker){
            set(destRef,null);
            if(distanceOverlay) distanceOverlay.setText("");
        }else{
            set(destRef,{lat:e.latLng.lat(),lng:e.latLng.lng()});
        }
    });

    // 목적지 구독
    const destRef = ref(db,"location/destination");
    onValue(destRef, snapshot => {
        const dest = snapshot.val();
        if(!dest){
            if(destinationMarker) destinationMarker.setMap(null);
            destinationMarker = null;
            directionsRenderer.setDirections({routes:[]});
            if(distanceOverlay) distanceOverlay.setText("");
            return;
        }
        const destPos = {lat:dest.lat,lng:dest.lng};
        if(!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);
        if(marker) drawRealRoute(marker.getPosition().toJSON(),destPos);
        lastPosition = marker ? marker.getPosition().toJSON() : null;
    });
};
</script>
<style>
body { margin:0; padding:0; min-height:100vh; }
#map {
    width:200px; height:200px; border:1px solid #000; border-radius:0px;
    transition: border-radius 0.2s ease, opacity 0.2s ease, width 0.2s ease, height 0.2s ease;
    position: absolute; top:0; right:0;
}
.gm-style-cc { bottom:-100px !important; right:-100px !important; }
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>
