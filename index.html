<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 맵</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=472f378af49957df6636a87b97fb6fd6&libraries=services"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, markerDiv, marker, addressDiv, distanceDiv;
let destinationMarker, routeLine;
let lastPosition = null; // 마지막 길찾기 호출 위치

// 내 위치 마커 생성
function createMarker(pos) {
    markerDiv = document.createElement('div');
    markerDiv.style.width = '0px';
    markerDiv.style.height = '0px';
    markerDiv.style.borderLeft = '10px solid transparent';
    markerDiv.style.borderRight = '10px solid transparent';
    markerDiv.style.borderBottom = '25px solid red';
    markerDiv.style.transformOrigin = '50% 62%';
    markerDiv.style.position = 'absolute';
    marker = new kakao.maps.CustomOverlay({
        position: pos,
        content: markerDiv,
        yAnchor: 0.5
    });
    marker.setMap(map);
}

// 주소 표시 div 생성
function createAddressDiv(container) {
    if (!addressDiv) {
        addressDiv = document.createElement('div');
        addressDiv.style.position = 'absolute';
        addressDiv.style.top = '0px';
        addressDiv.style.left = '50%';
        addressDiv.style.transform = 'translateX(-50%)';
        addressDiv.style.fontSize = '20px';
        addressDiv.style.fontWeight = '900';
        addressDiv.style.fontFamily = 'sans-serif';
        addressDiv.style.color = '#000';
        addressDiv.style.zIndex = '9999';
        addressDiv.style.whiteSpace = 'nowrap';
        container.appendChild(addressDiv);
    }
}

// 거리 표시 div 생성
function createDistanceDiv(container) {
    if (!distanceDiv) {
        distanceDiv = document.createElement('div');
        distanceDiv.style.position = 'absolute';
        distanceDiv.style.bottom = '0px';
        distanceDiv.style.left = '50%';
        distanceDiv.style.transform = 'translateX(-50%)';
        distanceDiv.style.fontSize = '16px';
        distanceDiv.style.fontWeight = 'bold';
        distanceDiv.style.fontFamily = 'sans-serif';
        distanceDiv.style.color = '#0066ff';
        distanceDiv.style.backgroundColor = 'rgba(255,255,255,0.8)';
        distanceDiv.style.padding = '5px 10px';
        distanceDiv.style.borderRadius = '8px';
        distanceDiv.style.zIndex = '9999';
        container.appendChild(distanceDiv);
    }
}

// 좌표 → 주소
const geocoder = new kakao.maps.services.Geocoder();
let currentAddress = {city:'', district:'', neighborhood:''};
function updateAddress(latlng) {
    geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            const region = result[0].address;
            currentAddress.city = region.region_1depth_name || '';
            currentAddress.district = region.region_2depth_name || '';
            currentAddress.neighborhood = region.region_3depth_name || '';
            refreshAddressText();
        } else {
            if (addressDiv) addressDiv.innerText = '주소를 가져올 수 없음';
        }
    });
}

function refreshAddressText() {
    if (!addressDiv) return;
    const container = document.getElementById("map");
    const mapSize = container.offsetWidth;
    let text;
    if (mapSize > 430) text = `${currentAddress.city} ${currentAddress.district} ${currentAddress.neighborhood}`;
    else if (mapSize > 330) text = `${currentAddress.district} ${currentAddress.neighborhood}`;
    else text = `${currentAddress.neighborhood}`;
    addressDiv.innerText = text;
}

// 거리 자동 단위 km/m
function updateDistanceText(data) {
    if (!distanceDiv || !data.routes || data.routes.length === 0) return;
    const dist = data.routes[0].summary.distance; // meters
    if (dist >= 1000) distanceDiv.innerText = `${(dist/1000).toFixed(2)} km`;
    else distanceDiv.innerText = `${dist} m`;
}

// 카카오 길찾기 REST API
async function fetchRoute(start, end) {
    const REST_KEY = "7d33e709ef0fe0717720fc11072d11ed";
    const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}&priority=RECOMMEND`;
    const response = await fetch(url, {
        method: "GET",
        headers: { Authorization: `KakaoAK ${REST_KEY}` }
    });
    const data = await response.json();
    return data;
}

// 실제 경로 Polyline
async function drawRealRoute(start, end) {
    if (!start || !end) return;
    if (routeLine) routeLine.setMap(null);
    try {
        const data = await fetchRoute(start, end);
        if (!data.routes || data.routes.length === 0) return;

        updateDistanceText(data);

        const path = [];
        const sections = data.routes[0].sections;
        sections.forEach(sec => {
            sec.roads.forEach(road => {
                for (let i = 0; i < road.vertexes.length; i += 2) {
                    const lng = road.vertexes[i];
                    const lat = road.vertexes[i + 1];
                    path.push(new kakao.maps.LatLng(lat, lng));
                }
            });
        });

        routeLine = new kakao.maps.Polyline({
            map: map,
            path: path,
            strokeWeight: 5,
            strokeColor: '#0066ff',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });
    } catch (e) {
        console.error("경로 가져오기 실패:", e);
    }
}

// ✅ 목적지 마커 생성 + 클릭 삭제
function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);

    const containerDiv = document.createElement('div');
    containerDiv.style.position = 'absolute';
    containerDiv.style.width = '30px';
    containerDiv.style.height = '40px';
    containerDiv.style.bottom = '5px';
    containerDiv.style.transform = 'translateX(-50%)';
    containerDiv.style.cursor = 'pointer';

    const diamondDiv = document.createElement('div');
    diamondDiv.style.width = '30px';
    diamondDiv.style.height = '40px';
    diamondDiv.style.backgroundColor = 'red';
    diamondDiv.style.clipPath = 'polygon(40% 30%, 60% 30%, 85% 45%, 50% 100%, 15% 45%)';

    containerDiv.appendChild(diamondDiv);

    destinationMarker = new kakao.maps.CustomOverlay({
        position: pos,
        content: containerDiv,
        yAnchor: 1
    });
    destinationMarker.setMap(map);

    // ✅ 직접 DOM 이벤트로 삭제
    containerDiv.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (kakao?.maps?.event?.preventMap) kakao.maps.event.preventMap();

        if (destinationMarker) { destinationMarker.setMap(null); destinationMarker = null; }
        if (routeLine) { routeLine.setMap(null); routeLine = null; }
        if (distanceDiv) distanceDiv.innerText = '';

        const destRef = ref(db, "location/destination");
        set(destRef, null);
    });
}

// 두 좌표 사이 거리 계산 (미터)
function getDistance(pos1, pos2) {
    return kakao.maps.LatLng.prototype.distance.call(pos1, pos2);
}

window.onload = function() {
    const container = document.getElementById('map');
    createAddressDiv(container);
    createDistanceDiv(container);

    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
    });

    // 내 위치 실시간 갱신
    const locRef = ref(db, "location/current");
    onValue(locRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const pos = new kakao.maps.LatLng(data.lat, data.lng);

        if (!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);

        if (data.level !== undefined) map.setLevel(data.level);
        if (data.borderRadius !== undefined) container.style.borderRadius = data.borderRadius + 'px';
        if (data.opacity !== undefined) container.style.opacity = data.opacity;
        if (data.mapSize !== undefined) {
            container.style.width = data.mapSize + 'px';
            container.style.height = data.mapSize + 'px';
            map.relayout();
            map.setCenter(pos);
            refreshAddressText();
        }

        if (data.heading !== undefined) markerDiv.style.transform = `translate(-50%, -62%) rotate(${data.heading}deg)`;
        else markerDiv.style.transform = `translate(-50%, -62%) rotate(0deg)`;

        updateAddress(pos);

        // 5m 이상 이동 시만 길찾기 호출
        if (destinationMarker) {
            const destPos = destinationMarker.getPosition();
            if (!lastPosition || getDistance(pos, lastPosition) > 5) {
                drawRealRoute(pos, destPos);
                lastPosition = pos;
            }
        }
    });

    // 지도 클릭 → 목적지 마커 + Firebase 저장
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const clickPos = mouseEvent.latLng;
        createDestinationMarker(clickPos);

        const destRef = ref(db, "location/destination");
        set(destRef, { lat: clickPos.getLat(), lng: clickPos.getLng() });

        if (marker) drawRealRoute(marker.getPosition(), clickPos);
        lastPosition = marker ? marker.getPosition() : null;
    });

    // ✅ 목적지 실시간 갱신 (null → 마커 지우기)
    const destRef = ref(db, "location/destination");
    onValue(destRef, (snapshot) => {
        const dest = snapshot.val();

        if (!dest) {
            if (destinationMarker) { destinationMarker.setMap(null); destinationMarker = null; }
            if (routeLine) { routeLine.setMap(null); routeLine = null; }
            if (distanceDiv) distanceDiv.innerText = '';
            return;
        }

        const destPos = new kakao.maps.LatLng(dest.lat, dest.lng);
        if (!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);

        if (marker) drawRealRoute(marker.getPosition(), destPos);
        lastPosition = marker ? marker.getPosition() : null;
    });

    window.addEventListener('resize', refreshAddressText);
};
</script>
<style>
body {
    margin:0; padding:0; min-height:100vh; position: relative;
}
#map {
    width:200px; height:200px; border:1px solid #000; border-radius:0px;
    transition: border-radius 0.2s ease, opacity 0.2s ease, width 0.2s ease, height 0.2s ease;
    position: absolute; top: 0; right: 0;
}
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>
