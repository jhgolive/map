<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ïã§ÏãúÍ∞Ñ Íµ¨Í∏ÄÎßµ</title>

<!-- Íµ¨Í∏Ä ÏßÄÎèÑ API Î∂àÎü¨Ïò§Í∏∞ (geometry ÎùºÏù¥Î∏åÎü¨Î¶¨ Ìè¨Ìï®) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8swteRAgf-r_tS_uncv_IWJKcGghanrY&libraries=geometry"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// --------------------------- Firebase Ï¥àÍ∏∞Ìôî ---------------------------
const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --------------------------- Ï†ÑÏó≠ Î≥ÄÏàò ---------------------------
let map, marker, destinationMarker;
let addressDiv, distanceDiv;
let geocoder, directionsService;
let lastPosition = null;
let routePolyline = null;
let lastDistanceMeters = null;

// --------------------------- ÏßÄÎèÑ Ïä§ÌÉÄÏùº ---------------------------
const normalStyle = [
  { featureType: "road", elementType: "labels.text.fill", stylers: [{ visibility: "off" }] },
  { featureType: "road", elementType: "labels.text.stroke", stylers: [{ visibility: "off" }] }
];

const darkModeStyle = [
  { elementType: "geometry", stylers: [{ color: "#212121" }] },
  { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
  { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
  { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
  { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#757575" }] },
  { featureType: "poi", elementType: "geometry", stylers: [{ color: "#303030" }] },
  { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#181818" }] },
  { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#2c2c2c" }] },
  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#1c1c1c" }] },
  { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }] },
    
  { featureType: "administrative", elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
  { featureType: "poi ", elementType: "labels.icon", stylers: [{ visibility: "on" }] },
  { featureType: "poi ", elementType: "labels.icon", stylers: [{ saturation: -100 }] },
  { featureType: "poi ", elementType: "labels.icon", stylers: [{ gamma: 0.5 }] },
  { featureType: "road", elementType: "labels.text.fill", stylers: [{ visibility: "off" }] },
  { featureType: "road", elementType: "labels.text.stroke", stylers: [{ visibility: "off" }] },
  { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "on" }] },
  { featureType: "road", elementType: "labels.icon", stylers: [{ gamma: 0.7 }] },
  { featureType: "transit", elementType: "geometry.fill", stylers: [{ lightness: 50 }] },
  { featureType: "transit", elementType: "labels.icon", stylers: [{ visibility: "on" }] },
  { featureType: "transit", elementType: "labels.icon", stylers: [{ saturation: -100 }] },
  { featureType: "transit", elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
  { featureType: "landscape", elementType: "geometry.stroke", stylers: [{ lightness: 50 }] }
];

const transparentStyle = [
  { featureType: "all", elementType: "geometry.fill", stylers: [{ visibility: "off" }] },
  { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },
  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#ffffff" }] },
  { featureType: "administrative", elementType: "geometry.stroke", stylers: [{ color: "#ff0000" }] },
  { featureType: "landscape", elementType: "geometry.stroke", stylers: [{ color: "#00ff00" }] },
  { featureType: "water", elementType: "geometry.stroke", stylers: [{ color: "#0000ff" }] },
    
  { featureType: "administrative", elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
  { featureType: "poi ", elementType: "labels.icon", stylers: [{ visibility: "on" }] },
  { featureType: "poi ", elementType: "labels.icon", stylers: [{ saturation: -100 }] },
  { featureType: "poi ", elementType: "labels.text.fill", stylers: [{ visibility: "on" }] },
  { featureType: "road", elementType: "geometry.fill", stylers: [{ visibility: "off" }] }, // ÎèÑÎ°úÌà¨Î™ÖÏù¥ ÏßÄÏ†ÄÎ∂ÑÌï¥ÏÑú Í∫ºÎÜà
  { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#00000000" }] }, // ÎèÑÎ°úÌà¨Î™Ö
  { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "on" }] },
  { featureType: "transit", elementType: "labels.icon", stylers: [{ visibility: "on" }] },
  { featureType: "transit", elementType: "labels.icon", stylers: [{ saturation: -100 }] },
  { featureType: "transit", elementType: "labels.text.fill", stylers: [{ visibility: "on" }] }
];

// --------------------------- ÎßàÏª§ ÏÉùÏÑ± ---------------------------
function createMarker(pos) {
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: { url: "data:image/svg+xml;utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40"><polygon points="12,10 18,10 25,15 15,40 5,15" fill="red"/></svg>`), scaledSize: new google.maps.Size(30, 40) }
    });
}

function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);
    destinationMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: { url: "data:image/svg+xml;utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="30" height="40"><polygon points="12,10 18,10 25,15 15,40 5,15" fill="blue"/></svg>`), scaledSize: new google.maps.Size(30, 40) }
    });
}

// --------------------------- Ï£ºÏÜå / Í±∞Î¶¨ ÌëúÏãú ---------------------------
function createAddressDiv() {
    if (!addressDiv) {
        addressDiv = document.createElement("div");
        addressDiv.style.fontSize = "20px";
        addressDiv.style.fontWeight = "900";
        addressDiv.style.backgroundColor = "transparent";
        addressDiv.style.color = "#000";
        addressDiv.style.textAlign = "center";
        addressDiv.style.width = "300px";
        addressDiv.style.overflow = "hidden";
        addressDiv.style.whiteSpace = "nowrap";
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(addressDiv);
    }
}

function createDistanceDiv() {
    if (!distanceDiv) {
        distanceDiv = document.createElement("div");
        distanceDiv.style.fontSize = "16px";
        distanceDiv.style.fontWeight = "bold";
        distanceDiv.style.backgroundColor = "transparent";
        distanceDiv.style.color = "#000";
        distanceDiv.style.textAlign = "center";
        distanceDiv.style.width = "120px";
        distanceDiv.style.overflow = "hidden";
        distanceDiv.style.whiteSpace = "nowrap";
        map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(distanceDiv);
    }
}

function simplifyName(name) {
    const map = {"ÏÑúÏö∏ÌäπÎ≥ÑÏãú":"ÏÑúÏö∏","Î∂ÄÏÇ∞Í¥ëÏó≠Ïãú":"Î∂ÄÏÇ∞","ÎåÄÍµ¨Í¥ëÏó≠Ïãú":"ÎåÄÍµ¨","Ïù∏Ï≤úÍ¥ëÏó≠Ïãú":"Ïù∏Ï≤ú","Í¥ëÏ£ºÍ¥ëÏó≠Ïãú":"Í¥ëÏ£º","ÎåÄÏ†ÑÍ¥ëÏó≠Ïãú":"ÎåÄÏ†Ñ","Ïö∏ÏÇ∞Í¥ëÏó≠Ïãú":"Ïö∏ÏÇ∞","ÏÑ∏Ï¢ÖÌäπÎ≥ÑÏûêÏπòÏãú":"ÏÑ∏Ï¢Ö","Ï†úÏ£ºÌäπÎ≥ÑÏûêÏπòÎèÑ":"Ï†úÏ£º","Í≤ΩÍ∏∞ÎèÑ":"Í≤ΩÍ∏∞","Í∞ïÏõêÎèÑ":"Í∞ïÏõê","Ï∂©Ï≤≠Î∂ÅÎèÑ":"Ï∂©Î∂Å","Ï∂©Ï≤≠ÎÇ®ÎèÑ":"Ï∂©ÎÇ®","Í≤ΩÏÉÅÎ∂ÅÎèÑ":"Í≤ΩÎ∂Å","Í≤ΩÏÉÅÎÇ®ÎèÑ":"Í≤ΩÎÇ®","Ï†ÑÎùºÎ∂ÅÎèÑ":"Ï†ÑÎ∂Å","Ï†ÑÎùºÎÇ®ÎèÑ":"Ï†ÑÎÇ®"};
    if (map[name]) return map[name];
    if (/Ï†ú?\d+Îèô$/.test(name)) return name.replace(/Ï†ú?\d+Îèô$/,"Îèô");
    if (/\d+Îèô$/.test(name)) return name.replace(/\d+Îèô$/,"Îèô");
    return name;
}

function updateAddress(lat,lng){
    const width = document.getElementById("map").offsetWidth;
    geocoder.geocode({ location: { lat, lng } }, (results,status)=>{
        if(status==="OK" && results.length){
            let selected = results.find(r=>/(Îèô|Ïùç|Î©¥)/.test(r.formatted_address))||results[0];
            let sido="", sigungu="", dong="";
            selected.formatted_address.split(" ").forEach(part=>{
                if(part.endsWith("Ïãú")||part.endsWith("ÎèÑ")) sido=simplifyName(part);
                else if(part.endsWith("Íµ¨")||part.endsWith("Íµ∞")) sigungu=simplifyName(part);
                else if(part.endsWith("Îèô")||part.endsWith("Ïùç")||part.endsWith("Î©¥")) dong=simplifyName(part);
            });
            let displayText="";
            if(width>430) displayText=[sido,sigungu,dong].filter(Boolean).join(" ");
            else if(width>330) displayText=[sigungu,dong].filter(Boolean).join(" ");
            else displayText=dong||sigungu||sido;
            addressDiv.innerText=displayText;
        }else addressDiv.innerText="Ï£ºÏÜåÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏùå";
    });
}

function updateDistanceText(distanceMeters){
    if(!distanceDiv) return;
    const mapSize=document.getElementById("map").offsetWidth;
    let text, unit;
    if(distanceMeters>=1000){ text=(distanceMeters/1000).toFixed(2); unit="km"; }
    else { text=distanceMeters.toFixed(0); unit="m"; }
    if(mapSize<200) distanceDiv.innerHTML=`${text}`;
    else distanceDiv.innerHTML=`${text} <span>${unit}</span>`;
}

// --------------------------- Í≤ΩÎ°ú Í∑∏Î¶¨Í∏∞ ---------------------------
function drawFlexibleRoute(start,end){
    const modes=[google.maps.TravelMode.WALKING,google.maps.TravelMode.BICYCLING,google.maps.TravelMode.DRIVING,google.maps.TravelMode.TRANSIT];
    function tryRoute(index){
        if(index>=modes.length){ if(distanceDiv) distanceDiv.innerText="Í≤ΩÎ°úÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå"; return; }
        directionsService.route({ origin:start, destination:end, travelMode:modes[index] }, (result,status)=>{
            if(status==="OK" && result.routes.length>0){
                if(routePolyline) routePolyline.setMap(null);
                const path=result.routes[0].overview_path;
                routePolyline=new google.maps.Polyline({ path:path,map:map,strokeColor:"#4285F4",strokeOpacity:1.0,strokeWeight:5 });
                const dist=result.routes[0].legs[0].distance.value;
                lastDistanceMeters=dist;
                updateDistanceText(dist);
            }else tryRoute(index+1);
        });
    }
    tryRoute(0);
}

// --------------------------- ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî ---------------------------
window.onload = function(){
    const container=document.getElementById("map");
    map=new google.maps.Map(container,{ center:{lat:37.5665,lng:126.9780}, zoom:14, disableDefaultUI:true, styles:darkModeStyle, backgroundColor:"transparent" });
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    createAddressDiv();
    createDistanceDiv();

    // --------------------------- Î™®Îìú Í∞êÏãú ---------------------------
    const modeRef=ref(db,"location/settings/mode");
    onValue(modeRef, snapshot=>{
        const mode=snapshot.val();
        if(mode===0) map.setOptions({styles:normalStyle});
        else if(mode===1) map.setOptions({styles:darkModeStyle});
        else if(mode===2) map.setOptions({styles:transparentStyle});

        if(mode===1){ addressDiv.style.color="#fff"; distanceDiv.style.color="#4285F4"; }
        else{ addressDiv.style.color="#000"; distanceDiv.style.color="#000"; }
    });

    // --------------------------- Î≤ÑÌäºÍ∞í Í∞êÏãú (buttonValues) ---------------------------
    const buttonRef=ref(db,"location/buttonValues");
    onValue(buttonRef, snapshot=>{
        const data=snapshot.val();
        if(!data) return;
        if(data.mapSize!==undefined){
            container.style.width=data.mapSize+"px";
            container.style.height=data.mapSize+"px";
            if(lastDistanceMeters!==null) updateDistanceText(lastDistanceMeters);
        
            // üëá Ï£ºÏÜåÎèÑ Îã§Ïãú Í∞±Ïã†
            if(marker){
                const pos = marker.getPosition().toJSON();
                updateAddress(pos.lat, pos.lng);
            }
        }
        if(data.opacity!==undefined) container.style.opacity=data.opacity;
        if(data.borderRadius!==undefined) container.style.borderRadius=data.borderRadius+"px";
        if(data.mapLevel!==undefined) map.setZoom(20-data.mapLevel);
    });

    // --------------------------- ÌòÑÏû¨ ÏúÑÏπò Í∞êÏãú (GPS) ---------------------------
    const locRef=ref(db,"location/current");
    onValue(locRef, snapshot=>{
        const data=snapshot.val();
        if(!data) return;
        const pos={lat:data.lat,lng:data.lng};
        if(!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);
        updateAddress(pos.lat,pos.lng);

        if(destinationMarker){
            const destPos=destinationMarker.getPosition().toJSON();
            if(!lastPosition || google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(pos), new google.maps.LatLng(lastPosition))>5){
                drawFlexibleRoute(pos,destPos);
                lastPosition=pos;
            }
        }
    });

    // --------------------------- Î™©Ï†ÅÏßÄ Í∞êÏãú ---------------------------
    const destRef=ref(db,"location/destination");
    onValue(destRef, snapshot=>{
        const dest=snapshot.val();
        if(!dest){ if(destinationMarker) destinationMarker.setMap(null); destinationMarker=null; if(routePolyline) routePolyline.setMap(null); distanceDiv.innerText=""; return; }
        const destPos={lat:dest.lat,lng:dest.lng};
        if(!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);
        if(marker) drawFlexibleRoute(marker.getPosition().toJSON(), destPos);
        lastPosition=marker?marker.getPosition().toJSON():null;
    });

    // --------------------------- ÏßÄÎèÑ ÌÅ¥Î¶≠/ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ ---------------------------
    let processingClick=false;
    function handleMapTap(lat,lng){
        if(processingClick) return;
        processingClick=true;
        const destRef=ref(db,"location/destination");
        if(destinationMarker){ set(destRef,null); if(routePolyline) routePolyline.setMap(null); distanceDiv.innerText=""; }
        else set(destRef,{lat,lng});
        setTimeout(()=>{ processingClick=false; },200);
    }

    map.getDiv().addEventListener("touchend", e=>{
        e.preventDefault();
        const point=new google.maps.Point(e.changedTouches[0].clientX,e.changedTouches[0].clientY);
        const latLng=map.getProjection().fromPointToLatLng(point);
        handleMapTap(latLng.lat(),latLng.lng());
    },{passive:false});

    map.addListener("click", e=>{ handleMapTap(e.latLng.lat(), e.latLng.lng()); });

    // --------------------------- ÌôîÎ©¥ Î¶¨ÏÇ¨Ïù¥Ï¶à ---------------------------
    window.addEventListener("resize", ()=>{
        if(marker){ const pos=marker.getPosition().toJSON(); updateAddress(pos.lat,pos.lng); }
        if(lastDistanceMeters!==null) updateDistanceText(lastDistanceMeters);
    });
};
</script>

<style>
body{margin:0;padding:0;min-height:100vh;}
#map{width:200px;height:200px;border:0;border-radius:0px;position:absolute;top:0;right:0;}
.gm-style-cc{bottom:-100px!important; right:-100px!important;}
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>




























