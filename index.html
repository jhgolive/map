<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 맵</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=472f378af49957df6636a87b97fb6fd6&libraries=services"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, markerDiv, marker, addressDiv, distanceDiv;
let destinationMarker, routeLine;

// 내 위치 마커 생성
function createMarker(pos) {
    markerDiv = document.createElement('div');
    markerDiv.style.width = '0px';
    markerDiv.style.height = '0px';
    markerDiv.style.borderLeft = '10px solid transparent';
    markerDiv.style.borderRight = '10px solid transparent';
    markerDiv.style.borderBottom = '25px solid red';
    markerDiv.style.transformOrigin = '50% 62%';
    markerDiv.style.position = 'absolute';
    marker = new kakao.maps.CustomOverlay({
        position: pos,
        content: markerDiv,
        yAnchor: 0.5
    });
    marker.setMap(map);
}

// 주소 표시 div 생성
function createAddressDiv(container) {
    if (!addressDiv) {
        addressDiv = document.createElement('div');
        addressDiv.style.position = 'absolute';
        addressDiv.style.top = '0px';
        addressDiv.style.left = '50%';
        addressDiv.style.transform = 'translateX(-50%)';
        addressDiv.style.fontSize = '20px';
        addressDiv.style.fontWeight = '900';
        addressDiv.style.fontFamily = 'sans-serif';
        addressDiv.style.color = '#000';
        addressDiv.style.zIndex = '9999';
        addressDiv.style.whiteSpace = 'nowrap';
        container.appendChild(addressDiv);
    }
}

// 거리 표시 div 생성
function createDistanceDiv(container) {
    if (!distanceDiv) {
        distanceDiv = document.createElement('div');
        distanceDiv.style.position = 'absolute';
        distanceDiv.style.bottom = '10px';
        distanceDiv.style.left = '50%';
        distanceDiv.style.transform = 'translateX(-50%)';
        distanceDiv.style.fontSize = '16px';
        distanceDiv.style.fontWeight = 'bold';
        distanceDiv.style.fontFamily = 'sans-serif';
        distanceDiv.style.color = '#0066ff';
        distanceDiv.style.backgroundColor = 'rgba(255,255,255,0.8)';
        distanceDiv.style.padding = '5px 10px';
        distanceDiv.style.borderRadius = '8px';
        distanceDiv.style.zIndex = '9999';
        container.appendChild(distanceDiv);
    }
}

// 좌표 → 주소
const geocoder = new kakao.maps.services.Geocoder();
let currentAddress = {city:'', district:'', neighborhood:''};
function updateAddress(latlng) {
    geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            const region = result[0].address;
            currentAddress.city = region.region_1depth_name || '';
            currentAddress.district = region.region_2depth_name || '';
            currentAddress.neighborhood = region.region_3depth_name || '';
            refreshAddressText();
        } else {
            if (addressDiv) addressDiv.innerText = '주소를 가져올 수 없음';
        }
    });
}

function refreshAddressText() {
    if (!addressDiv) return;
    const container = document.getElementById("map");
    const mapSize = container.offsetWidth;
    let text;
    if (mapSize > 430) text = `${currentAddress.city} ${currentAddress.district} ${currentAddress.neighborhood}`;
    else if (mapSize > 330) text = `${currentAddress.district} ${currentAddress.neighborhood}`;
    else text = `${currentAddress.neighborhood}`;
    addressDiv.innerText = text;
}

// 거리 자동 단위 km/m
function updateDistanceText(data) {
    if (!distanceDiv || !data.routes || data.routes.length === 0) return;
    const dist = data.routes[0].summary.distance; // meters
    if (dist >= 1000) distanceDiv.innerText = `거리: ${(dist/1000).toFixed(2)} km`;
    else distanceDiv.innerText = `거리: ${dist} m`;
}

// 카카오 길찾기 REST API
async function fetchRoute(start, end) {
    const REST_KEY = "3ac67731ae146851f36e5631da29c4dd";
    const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}&priority=RECOMMEND`;
    const response = await fetch(url, {
        method: "GET",
        headers: { Authorization: `KakaoAK ${REST_KEY}` }
    });
    const data = await response.json();
    return data;
}

// 실제 경로 Polyline
async function drawRealRoute(start, end) {
    if (!start || !end) return;
    if (routeLine) routeLine.setMap(null);
    try {
        const data = await fetchRoute(start, end);
        if (!data.routes || data.routes.length === 0) return;

        updateDistanceText(data);

        const path = [];
        const sections = data.routes[0].sections;
        sections.forEach(sec => {
            sec.roads.forEach(road => {
                for (let i = 0; i < road.vertexes.length; i += 2) {
                    const lng = road.vertexes[i];
                    const lat = road.vertexes[i + 1];
                    path.push(new kakao.maps.LatLng(lat, lng));
                }
            });
        });

        routeLine = new kakao.maps.Polyline({
            map: map,
            path: path,
            strokeWeight: 5,
            strokeColor: '#0066ff',
            strokeOpacity: 0.8,
            strokeStyle: 'solid'
        });
    } catch (e) {
        console.error("경로 가져오기 실패:", e);
    }
}

// 목적지 마커 생성 (세워진 다이아몬드, 밑 꼭지점이 실제 위치)
function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);

    const diamondDiv = document.createElement('div');
    diamondDiv.style.width = '20px';      
    diamondDiv.style.height = '30px';     
    diamondDiv.style.backgroundColor = '#00b0ff';
    diamondDiv.style.position = 'absolute';

    // 다이아몬드 모양 (위아래 뾰족)
    diamondDiv.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)';

    // 중앙 정렬 (좌우 기준점 맞추기)
    diamondDiv.style.transform = 'translateX(-50%)';

    destinationMarker = new kakao.maps.CustomOverlay({
        position: pos,
        content: diamondDiv,
        yAnchor: 1   // 밑 꼭지점이 실제 위치
    });
    destinationMarker.setMap(map);

    // 클릭 시 삭제
    kakao.maps.event.addListener(destinationMarker, 'click', () => {
        destinationMarker.setMap(null);
        const destRef = ref(db, "location/destination");
        set(destRef, null);
    });
}

window.onload = function() {
    const container = document.getElementById('map');
    createAddressDiv(container);
    createDistanceDiv(container);

    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
    });

    // 내 위치 실시간 갱신
    const locRef = ref(db, "location/current");
    onValue(locRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const pos = new kakao.maps.LatLng(data.lat, data.lng);
        if (!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);

        if (data.level !== undefined) map.setLevel(data.level);
        if (data.borderRadius !== undefined) container.style.borderRadius = data.borderRadius + 'px';
        if (data.opacity !== undefined) container.style.opacity = data.opacity;
        if (data.mapSize !== undefined) {
            container.style.width = data.mapSize + 'px';
            container.style.height = data.mapSize + 'px';
            map.relayout();
            map.setCenter(pos);
            refreshAddressText();
        }

        if (data.heading !== undefined) markerDiv.style.transform = `translate(-50%, -62%) rotate(${data.heading}deg)`;
        else markerDiv.style.transform = `translate(-50%, -62%) rotate(0deg)`;

        updateAddress(pos);

        if (destinationMarker) drawRealRoute(pos, destinationMarker.getPosition());
    });

    // 지도 클릭 → 목적지 마커 + Firebase 저장
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const clickPos = mouseEvent.latLng;
        createDestinationMarker(clickPos);

        const destRef = ref(db, "location/destination");
        set(destRef, { lat: clickPos.getLat(), lng: clickPos.getLng() });

        if (marker) drawRealRoute(marker.getPosition(), clickPos);
    });

    // 목적지 실시간 갱신
    const destRef = ref(db, "location/destination");
    onValue(destRef, (snapshot) => {
        const dest = snapshot.val();
        if (!dest) return;
        const destPos = new kakao.maps.LatLng(dest.lat, dest.lng);
        if (!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);
        if (marker) drawRealRoute(marker.getPosition(), destPos);
    });

    window.addEventListener('resize', refreshAddressText);
};
</script>
<style>
body {
    margin:0; padding:0; min-height:100vh; position: relative;
}
#map {
    width:200px; height:200px; border:1px solid #000; border-radius:0px;
    transition: border-radius 0.2s ease, opacity 0.2s ease, width 0.2s ease, height 0.2s ease;
    position: absolute; top: 0; right: 0;
}
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>






