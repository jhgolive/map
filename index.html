<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ì‹¤ì‹œê°„ êµ¬ê¸€ë§µ</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8swteRAgf-r_tS_uncv_IWJKcGghanrY&libraries=geometry"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
    authDomain: "mygps-11798.firebaseapp.com",
    databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mygps-11798",
    storageBucket: "mygps-11798.firebasestorage.app",
    messagingSenderId: "271371741627",
    appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, marker, destinationMarker;
let addressDiv, distanceDiv;
let geocoder, directionsService;
let lastPosition = null;
let routePolyline = null;
let clickTimeout = null;

// ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼
const darkModeStyle = [
  { elementType: "geometry", stylers: [{ color: "#212121" }] },
  { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
  { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
  { elementType: "labels.text.stroke", stylers: [{ color: "#212121" }] },
  { featureType: "administrative", elementType: "geometry", stylers: [{ color: "#757575" }] },
  { featureType: "poi", elementType: "geometry", stylers: [{ color: "#303030" }] },
  { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#181818" }] },
  { featureType: "road", elementType: "geometry.fill", stylers: [{ color: "#2c2c2c" }] },
  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#1c1c1c" }] },
  { featureType: "water", elementType: "geometry", stylers: [{ color: "#000000" }] }
];

// âœ… ìœ¤ê³½ì„  + íˆ¬ëª… ìŠ¤íƒ€ì¼
const transparentStyle = [
  { featureType: "all", elementType: "geometry.fill", stylers: [{ visibility: "off" }] },              
  { featureType: "all", elementType: "labels", stylers: [{ visibility: "off" }] },                      
  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#ffffff" }] },            
  { featureType: "administrative", elementType: "geometry.stroke", stylers: [{ color: "#ff0000" }] },  
  { featureType: "landscape", elementType: "geometry.stroke", stylers: [{ color: "#00ff00" }] },       
  { featureType: "water", elementType: "geometry.stroke", stylers: [{ color: "#0000ff" }] }            
];

// ë‚´ ìœ„ì¹˜ ë§ˆì»¤
function createMarker(pos) {
    if (marker) marker.setMap(null);
    marker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            url: "data:image/svg+xml;utf-8," + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40">
                  <polygon points="12,10 18,10 25,15 15,40 5,15" fill="red"/>
                </svg>`),
            scaledSize: new google.maps.Size(30, 40)
        }
    });
}

// ëª©ì ì§€ ë§ˆì»¤
function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);
    destinationMarker = new google.maps.Marker({
        position: pos,
        map: map,
        icon: {
            url: "data:image/svg+xml;utf-8," + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40">
                  <polygon points="12,10 18,10 25,15 15,40 5,15" fill="blue"/>
                </svg>`),
            scaledSize: new google.maps.Size(30, 40)
        }
    });
}

// ì£¼ì†Œ div
function createAddressDiv() {
    if (!addressDiv) {
        addressDiv = document.createElement("div");
        addressDiv.style.fontSize = "20px";
        addressDiv.style.fontWeight = "900";
        addressDiv.style.padding = "0"; 
        addressDiv.style.backgroundColor = "transparent"; 
        addressDiv.style.color = "#000";
        addressDiv.style.textAlign = "center"; 
        addressDiv.style.width = "300px"; 
        addressDiv.style.overflow = "hidden";    
        addressDiv.style.whiteSpace = "nowrap";  
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(addressDiv);
    }
}

// ê±°ë¦¬ div
function createDistanceDiv() {
    if (!distanceDiv) {
        distanceDiv = document.createElement("div");
        distanceDiv.style.fontSize = "16px";
        distanceDiv.style.fontWeight = "bold";
        distanceDiv.style.padding = "0"; 
        distanceDiv.style.backgroundColor = "transparent"; 
        distanceDiv.style.color = "#000";
        distanceDiv.style.textAlign = "center";  
        distanceDiv.style.width = "120px"; 
        distanceDiv.style.overflow = "hidden";    
        distanceDiv.style.whiteSpace = "nowrap";  
        map.controls[google.maps.ControlPosition.BOTTOM_CENTER].push(distanceDiv);
    }
}

// ì£¼ì†Œ ì—…ë°ì´íŠ¸
function simplifyName(name) {
    const map = {
        "ì„œìš¸íŠ¹ë³„ì‹œ": "ì„œìš¸", "ë¶€ì‚°ê´‘ì—­ì‹œ": "ë¶€ì‚°", "ëŒ€êµ¬ê´‘ì—­ì‹œ": "ëŒ€êµ¬",
        "ì¸ì²œê´‘ì—­ì‹œ": "ì¸ì²œ", "ê´‘ì£¼ê´‘ì—­ì‹œ": "ê´‘ì£¼", "ëŒ€ì „ê´‘ì—­ì‹œ": "ëŒ€ì „",
        "ìš¸ì‚°ê´‘ì—­ì‹œ": "ìš¸ì‚°", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ": "ì„¸ì¢…", "ì œì£¼íŠ¹ë³„ìì¹˜ë„": "ì œì£¼",
        "ê²½ê¸°ë„": "ê²½ê¸°", "ê°•ì›ë„": "ê°•ì›", "ì¶©ì²­ë¶ë„": "ì¶©ë¶", "ì¶©ì²­ë‚¨ë„": "ì¶©ë‚¨",
        "ê²½ìƒë¶ë„": "ê²½ë¶", "ê²½ìƒë‚¨ë„": "ê²½ë‚¨", "ì „ë¼ë¶ë„": "ì „ë¶", "ì „ë¼ë‚¨ë„": "ì „ë‚¨"
    };
    if (map[name]) return map[name];
    if (/ì œ?\d+ë™$/.test(name)) return name.replace(/ì œ?\d+ë™$/, "ë™");
    if (/\d+ë™$/.test(name)) return name.replace(/\d+ë™$/, "ë™");
    return name;
}

function updateAddress(lat, lng) {
    const width = document.getElementById("map").offsetWidth;
    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === "OK" && results.length) {
            let selected = results.find(r => /(ë™|ì|ë©´)/.test(r.formatted_address)) || results[0];
            let sido = "", sigungu = "", dong = "";
            selected.formatted_address.split(" ").forEach(part => {
                if (part.endsWith("ì‹œ") || part.endsWith("ë„")) sido = simplifyName(part);
                else if (part.endsWith("êµ¬") || part.endsWith("êµ°")) sigungu = simplifyName(part);
                else if (part.endsWith("ë™") || part.endsWith("ì") || part.endsWith("ë©´")) dong = simplifyName(part);
            });
            let displayText = "";
            if (width > 430) displayText = [sido, sigungu, dong].filter(Boolean).join(" ");
            else if (width > 330) displayText = [sigungu, dong].filter(Boolean).join(" ");
            else displayText = dong || sigungu || sido;
            addressDiv.innerText = displayText;
        } else {
            addressDiv.innerText = "ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŒ";
        }
    });
}

// ê±°ë¦¬ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateDistanceText(distanceMeters) {
    if (!distanceDiv) return;
    const mapSize = document.getElementById("map").offsetWidth;
    let text, unit;
    if (distanceMeters >= 1000) {
        text = (distanceMeters / 1000).toFixed(2);
        unit = "km";
    } else {
        text = distanceMeters.toFixed(0);
        unit = "m";
    }
    if (mapSize < 200) distanceDiv.innerHTML = `${text}`;
    else distanceDiv.innerHTML = `${text} <span>${unit}</span>`;
}

// ê²½ë¡œ ê·¸ë¦¬ê¸°
function drawFlexibleRoute(start, end) {
    const modes = [
        google.maps.TravelMode.WALKING,
        google.maps.TravelMode.BICYCLING,
        google.maps.TravelMode.DRIVING,
        google.maps.TravelMode.TRANSIT
    ];
    function tryRoute(index) {
        if (index >= modes.length) {
            if (distanceDiv) distanceDiv.innerText = "ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ";
            return;
        }
        directionsService.route({
            origin: start,
            destination: end,
            travelMode: modes[index]
        }, (result, status) => {
            if (status === "OK" && result.routes.length > 0) {
                if (routePolyline) routePolyline.setMap(null);
                const path = result.routes[0].overview_path;
                routePolyline = new google.maps.Polyline({
                    path: path,
                    map: map,
                    strokeColor: "#4285F4",
                    strokeOpacity: 1.0,
                    strokeWeight: 5
                });
                const dist = result.routes[0].legs[0].distance.value;
                updateDistanceText(dist);
            } else {
                tryRoute(index + 1);
            }
        });
    }
    tryRoute(0);
}

window.onload = function() {
    const container = document.getElementById("map");
    map = new google.maps.Map(container, {
        center: {lat: 37.5665, lng: 126.9780},
        zoom: 14,
        disableDefaultUI: true,
        styles: darkModeStyle,
        backgroundColor: "transparent"
    });

    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();

    createAddressDiv();
    createDistanceDiv();

    const modeRef = ref(db, "location/settings/mode");
    onValue(modeRef, (snapshot) => {
        const mode = snapshot.val();
        if (mode === 0) map.setOptions({ styles: [] });
        else if (mode === 1) map.setOptions({ styles: darkModeStyle });
        else if (mode === 2) map.setOptions({ styles: transparentStyle });

        // ê¸€ì ìƒ‰ìƒ ë° í…Œë‘ë¦¬ ì„¤ì •
        if (mode === 1) { // ë‹¤í¬ëª¨ë“œ
            addressDiv.style.color = "#fff";
            addressDiv.style.webkitTextStroke = "";
            distanceDiv.style.color = "#4285F4";
            distanceDiv.style.webkitTextStroke = "";
        } else if (mode === 2) { // íˆ¬ëª…ëª¨ë“œ
            addressDiv.style.color = "#000";
            addressDiv.style.webkitTextStroke = ""; 
            distanceDiv.style.color = "#000";
            distanceDiv.style.webkitTextStroke = "";
        } else { // ì¼ë°˜ëª¨ë“œ
            addressDiv.style.color = "#000";
            addressDiv.style.webkitTextStroke = "";
            distanceDiv.style.color = "#000";
            distanceDiv.style.webkitTextStroke = "";
        }
    });

    const locRef = ref(db, "location/current");
    onValue(locRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const pos = {lat: data.lat, lng: data.lng};
        if (!marker) createMarker(pos);
        else marker.setPosition(pos);
        map.setCenter(pos);
        if (data.level !== undefined) map.setZoom(20 - data.level);
        if (data.mapSize !== undefined) {
            container.style.width = data.mapSize + "px";
            container.style.height = data.mapSize + "px";
            // ğŸ”´ ì§ì„ ê±°ë¦¬ ì œê±° â†’ ê²½ë¡œ ê±°ë¦¬ë§Œ í‘œì‹œ
        }
        if (data.opacity !== undefined) container.style.opacity = data.opacity;
        if (data.borderRadius !== undefined) container.style.borderRadius = data.borderRadius + "px";
        updateAddress(pos.lat, pos.lng);
        if (destinationMarker) {
            const destPos = destinationMarker.getPosition().toJSON();
            if (!lastPosition || google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(pos), new google.maps.LatLng(lastPosition)) > 5) {
                drawFlexibleRoute(pos, destPos);
                lastPosition = pos;
            }
        }
    });

    let processingClick = false;
    
    function handleMapTap(lat, lng) {
        if (processingClick) return;
        processingClick = true;
    
        const destRef = ref(db, "location/destination");
    
        if (destinationMarker) {
            // ëª©ì ì§€ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            set(destRef, null);
            if (routePolyline) routePolyline.setMap(null);
            distanceDiv.innerText = "";
        } else {
            // ëª©ì ì§€ê°€ ì—†ìœ¼ë©´ ìƒì„±
            set(destRef, { lat: lat, lng: lng });
        }
    
        // í”Œë˜ê·¸ ì´ˆê¸°í™”: 200ms í›„
        setTimeout(() => { processingClick = false; }, 200);
    }
    
    // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸
    map.getDiv().addEventListener("touchend", (e) => {
        e.preventDefault();
        const point = new google.maps.Point(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        const latLng = map.getProjection().fromPointToLatLng(point);
        handleMapTap(latLng.lat(), latLng.lng());
    }, { passive: false });
    
    // PC í´ë¦­ ì´ë²¤íŠ¸
    map.addListener("click", (e) => {
        handleMapTap(e.latLng.lat(), e.latLng.lng());
    });

    const destRef = ref(db, "location/destination");
    onValue(destRef, (snapshot) => {
        const dest = snapshot.val();
        if (!dest) {
            if (destinationMarker) destinationMarker.setMap(null);
            destinationMarker = null;
            if (routePolyline) routePolyline.setMap(null);
            distanceDiv.innerText = "";
            return;
        }
        const destPos = {lat: dest.lat, lng: dest.lng};
        if (!destinationMarker) createDestinationMarker(destPos);
        else destinationMarker.setPosition(destPos);
        if (marker) drawFlexibleRoute(marker.getPosition().toJSON(), destPos);
        lastPosition = marker ? marker.getPosition().toJSON() : null;
    });

    window.addEventListener("resize", () => {
        if (marker) {
            const pos = marker.getPosition().toJSON();
            updateAddress(pos.lat, pos.lng);
        }
    
        // ğŸ”¹ ê²½ë¡œ ê°±ì‹ ì€ í•˜ì§€ ì•Šê³ , ë‹¨ìœ„ë§Œ ì¦‰ì‹œ ê°±ì‹ 
        if (distanceDiv && distanceDiv.innerText.trim() !== "") {
            const rawText = distanceDiv.innerText;
            const numeric = parseFloat(rawText);  // ìˆ«ìë§Œ ì¶”ì¶œ
    
            if (!isNaN(numeric)) {
                // km ë‹¨ìœ„ì˜€ëŠ”ì§€ ì²´í¬í•´ì„œ ë‹¤ì‹œ í™˜ì‚°
                let distanceMeters;
                if (rawText.includes("km")) {
                    distanceMeters = numeric * 1000;
                } else {
                    distanceMeters = numeric;
                }
    
                // âœ… map í¬ê¸°ë¥¼ ë‹¤ì‹œ ì²´í¬í•´ì„œ ë‹¨ìœ„ ë¶™ì¼ì§€/ëº„ì§€ ê²°ì •
                updateDistanceText(distanceMeters);
            }
        }
    });
};
</script>
<style>
body { margin:0; padding:0; min-height:100vh; }
#map {
    width:200px; height:200px; border:0; border-radius:0px;
    position: absolute; top: 0; right: 0;
}
.gm-style-cc {
    bottom: -100px !important;
    right: -100px !important;
}
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>



