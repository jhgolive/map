<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 맵</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=472f378af49957df6636a87b97fb6fd6&libraries=services"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAQGtOEcxFxl9FV7NASLgxLDc23u2vzS_0",
  authDomain: "mygps-11798.firebaseapp.com",
  databaseURL: "https://mygps-11798-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mygps-11798",
  storageBucket: "mygps-11798.firebasestorage.app",
  messagingSenderId: "271371741627",
  appId: "1:271371741627:web:642901f43c5ad57d80bc9e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map;
let currentMarker, distanceMarker;
let destinationMarker, routeLine;

// 내 위치 마커 생성
function createCurrentMarker(pos) {
  const markerDiv = document.createElement("div");
  markerDiv.style.width = "0px";
  markerDiv.style.height = "0px";
  markerDiv.style.borderLeft = "10px solid transparent";
  markerDiv.style.borderRight = "10px solid transparent";
  markerDiv.style.borderBottom = "25px solid red";
  markerDiv.style.transformOrigin = "50% 62%";

  currentMarker = new kakao.maps.Marker({
    position: pos,
    map: map,
    clickable: false,
    content: markerDiv
  });
}

// 거리 표시용 마커 생성/업데이트
function updateDistanceMarker(pos, distance) {
  let text = (distance >= 1000) ? (distance / 1000).toFixed(1) + " km" : distance + " m";

  const distanceDiv = document.createElement("div");
  distanceDiv.style.background = "white";
  distanceDiv.style.border = "1px solid #333";
  distanceDiv.style.borderRadius = "10px";
  distanceDiv.style.padding = "2px 6px";
  distanceDiv.style.fontSize = "14px";
  distanceDiv.style.fontWeight = "bold";
  distanceDiv.style.color = "red";
  distanceDiv.style.whiteSpace = "nowrap";
  distanceDiv.innerText = text;

  if (!distanceMarker) {
    distanceMarker = new kakao.maps.Marker({
      position: pos,
      map: map,
      clickable: false,
      zIndex: 9999,
      content: distanceDiv
    });
  } else {
    distanceMarker.setPosition(pos);
    distanceMarker.setContent(distanceDiv);
  }
}

// 카카오 길찾기 REST API
async function fetchRoute(start, end) {
  const REST_KEY = "3ac67731ae146851f36e5631da29c4dd";
  const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.getLng()},${start.getLat()}&destination=${end.getLng()},${end.getLat()}&priority=RECOMMEND`;
  const response = await fetch(url, {
    method: "GET",
    headers: { Authorization: `KakaoAK ${REST_KEY}` }
  });
  return await response.json();
}

// 경로 Polyline 그리기 + 거리 표시
async function drawRoute(start, end) {
  if (!start || !end) return;
  if (routeLine) routeLine.setMap(null);

  try {
    const data = await fetchRoute(start, end);
    if (!data.routes || data.routes.length === 0) return;

    const totalDistance = data.routes[0].summary.distance;

    const path = [];
    data.routes[0].sections.forEach(sec => {
      sec.roads.forEach(road => {
        for (let i = 0; i < road.vertexes.length; i += 2) {
          path.push(new kakao.maps.LatLng(road.vertexes[i+1], road.vertexes[i]));
        }
      });
    });

    routeLine = new kakao.maps.Polyline({
      map: map,
      path: path,
      strokeWeight: 5,
      strokeColor: "#0066ff",
      strokeOpacity: 0.8,
      strokeStyle: "solid"
    });

    // 내 위치 위에 거리 표시
    updateDistanceMarker(start, totalDistance);
  } catch (e) {
    console.error("경로 가져오기 실패:", e);
  }
}

window.onload = function() {
  const container = document.getElementById("map");
  map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 4 });

  // 내 위치 실시간 갱신
  const locRef = ref(db, "location/current");
  onValue(locRef, snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const pos = new kakao.maps.LatLng(data.lat, data.lng);

    if (!currentMarker) createCurrentMarker(pos);
    else currentMarker.setPosition(pos);

    // 지도 부드럽게 이동
    map.panTo(pos);

    if (destinationMarker) drawRoute(pos, destinationMarker.getPosition());
  });

  // 지도 클릭 → 목적지 마커 + Firebase 저장
  kakao.maps.event.addListener(map, "click", mouseEvent => {
    const clickPos = mouseEvent.latLng;
    if (destinationMarker) destinationMarker.setMap(null);

    destinationMarker = new kakao.maps.Marker({
      position: clickPos,
      map: map,
      title: "목적지"
    });

    set(ref(db, "location/destination"), { lat: clickPos.getLat(), lng: clickPos.getLng() });

    if (currentMarker) drawRoute(currentMarker.getPosition(), clickPos);
  });

  // 목적지 실시간 갱신
  const destRef = ref(db, "location/destination");
  onValue(destRef, snapshot => {
    const dest = snapshot.val();
    if (!dest) return;
    const destPos = new kakao.maps.LatLng(dest.lat, dest.lng);

    if (!destinationMarker) {
      destinationMarker = new kakao.maps.Marker({ position: destPos, map: map, title: "목적지" });
    } else {
      destinationMarker.setPosition(destPos);
    }

    if (currentMarker) drawRoute(currentMarker.getPosition(), destPos);
  });
};
</script>
<style>
body { margin:0; padding:0; min-height:100vh; position: relative; }
#map { 
  width:200px; 
  height:200px; 
  border:1px solid #000; 
  border-radius:0px; 
  position: absolute; 
  top:0; 
  right:0; 
}
</style>
</head>
<body>
<div id="map"></div>
</body>
</html>
