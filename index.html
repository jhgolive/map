<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = { /* 기존 설정 */ };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map, markerDiv, marker, addressDiv;
let destMarker = null; // 목적지 마커
let polyline = null;   // 길 표시

// 내 위치 마커 생성
function createMarker(pos) {
  markerDiv = document.createElement('div');
  markerDiv.style.width = '0px';
  markerDiv.style.height = '0px';
  markerDiv.style.borderLeft = '10px solid transparent';
  markerDiv.style.borderRight = '10px solid transparent';
  markerDiv.style.borderBottom = '25px solid red';
  markerDiv.style.transformOrigin = '50% 62%';
  markerDiv.style.position = 'absolute';

  marker = new kakao.maps.CustomOverlay({
    position: pos,
    content: markerDiv,
    yAnchor: 0.5
  });
  marker.setMap(map);
}

// 목적지 마커 생성
function toggleDestMarker(pos) {
  if (destMarker) {
    destMarker.setMap(null);
    destMarker = null;
    if (polyline) {
      polyline.setMap(null);
      polyline = null;
    }
  } else {
    const markerDiv2 = document.createElement('div');
    markerDiv2.style.width = '0px';
    markerDiv2.style.height = '0px';
    markerDiv2.style.borderLeft = '10px solid transparent';
    markerDiv2.style.borderRight = '10px solid transparent';
    markerDiv2.style.borderBottom = '25px solid blue';
    markerDiv2.style.transformOrigin = '50% 62%';
    markerDiv2.style.position = 'absolute';

    destMarker = new kakao.maps.CustomOverlay({
      position: pos,
      content: markerDiv2,
      yAnchor: 0.5
    });
    destMarker.setMap(map);

    // 길 표시
    drawRoute(marker.getPosition(), pos);
  }
}

// 간단 경로 그리기
function drawRoute(start, end) {
  if (polyline) polyline.setMap(null);

  const path = [start, end]; // 직선으로 연결
  polyline = new kakao.maps.Polyline({
    path: path,
    strokeWeight: 4,
    strokeColor: '#00f',
    strokeOpacity: 0.7,
    strokeStyle: 'solid'
  });
  polyline.setMap(map);
}

window.onload = function() {
  const container = document.getElementById('map');
  createAddressDiv(container);

  map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 4 });

  // 내 위치 DB 구독
  const locRef = ref(db, "location/current");
  onValue(locRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const pos = new kakao.maps.LatLng(data.lat, data.lng);

    if (!marker) createMarker(pos);
    else marker.setPosition(pos);

    map.setCenter(pos);

    if (data.level !== undefined) map.setLevel(data.level);
    if (data.mapSize !== undefined) {
      container.style.width = data.mapSize + 'px';
      container.style.height = data.mapSize + 'px';
      map.relayout();
      map.setCenter(pos);
      refreshAddressText();
    }
    if (data.heading !== undefined) markerDiv.style.transform = `translate(-50%, -62%) rotate(${data.heading}deg)`;
    else markerDiv.style.transform = `translate(-50%, -62%) rotate(0deg)`;

    updateAddress(pos);
  });

  // 지도 클릭 이벤트
  kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
    const clickPos = mouseEvent.latLng;
    toggleDestMarker(clickPos);
  });

  window.addEventListener('resize', refreshAddressText);
};
</script>
