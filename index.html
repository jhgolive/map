<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 맵</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=472f378af49957df6636a87b97fb6fd6&libraries=services"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// ✅ Firebase 설정
const firebaseConfig = {
    apiKey: "AIzaSyAVuT8Rg0u_xfRoKw6dzyyM9whcX8yLjP8",
    authDomain: "jhmap-4d7af.firebaseapp.com",
    databaseURL: "https://jhmap-4d7af-default-rtdb.firebaseio.com",
    projectId: "jhmap-4d7af",
    storageBucket: "jhmap-4d7af.appspot.com",
    messagingSenderId: "901267380828",
    appId: "1:901267380828:web:40c4d1e84992a07f67f2df"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ✅ 지도 초기화
const mapContainer = document.createElement('div');
mapContainer.style.width = '100%';
mapContainer.style.height = '100vh';
document.body.appendChild(mapContainer);

const map = new kakao.maps.Map(mapContainer, {
    center: new kakao.maps.LatLng(37.5665, 126.9780),
    level: 3
});

let destinationMarker = null;
let routeLine = null;
let distanceDiv = null;

// ✅ 목적지 마커 생성 + 클릭 삭제
function createDestinationMarker(pos) {
    if (destinationMarker) destinationMarker.setMap(null);

    const containerDiv = document.createElement('div');
    containerDiv.style.position = 'absolute';
    containerDiv.style.width = '30px';
    containerDiv.style.height = '40px';
    containerDiv.style.bottom = '5px';
    containerDiv.style.transform = 'translateX(-50%)';
    containerDiv.style.cursor = 'pointer';

    const diamondDiv = document.createElement('div');
    diamondDiv.style.width = '30px';
    diamondDiv.style.height = '40px';
    diamondDiv.style.backgroundColor = 'red';
    diamondDiv.style.clipPath = 'polygon(40% 30%, 60% 30%, 85% 45%, 50% 100%, 15% 45%)';

    containerDiv.appendChild(diamondDiv);

    destinationMarker = new kakao.maps.CustomOverlay({
        position: pos,
        content: containerDiv,
        yAnchor: 1,
        clickable: true   // ✅ 오버레이 클릭 가능
    });
    destinationMarker.setMap(map);

    // ✅ 클릭 시 삭제
    containerDiv.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (destinationMarker) { destinationMarker.setMap(null); destinationMarker = null; }
        if (routeLine) { routeLine.setMap(null); routeLine = null; }
        if (distanceDiv) distanceDiv.innerText = '';

        const destRef = ref(db, "location/destination");
        set(destRef, null);
    };
}

// ✅ Firebase 에서 목적지 좌표 실시간 반영
const destRef = ref(db, "location/destination");
onValue(destRef, (snapshot) => {
    const val = snapshot.val();
    if (val) {
        createDestinationMarker(new kakao.maps.LatLng(val.lat, val.lng));
    } else {
        if (destinationMarker) { destinationMarker.setMap(null); destinationMarker = null; }
    }
});

</script>
</head>
<body>
</body>
</html>
