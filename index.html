<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>실시간 맵</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8swteRAgf-r_tS_uncv_IWJKcGghanrY"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// ✅ Firebase 설정
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let map;
let marker;

// ✅ 구글맵 다크 모드 스타일
const darkStyle = [
  { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
  { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
  { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
  { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
  { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
  { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
  { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
  { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
  { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
  { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
  { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
  { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
  { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
  { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
  { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
  { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
  { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
  { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] }
];

// ✅ 맵 초기화
function initMap(lat = 37.5665, lng = 126.9780) {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng },
    zoom: 15,
    mapTypeControl: false
  });

  marker = new google.maps.Marker({
    position: { lat, lng },
    map: map,
    title: "현재 위치"
  });
}

// ✅ 위치 데이터 구독
onValue(ref(db, "location/coords"), (snap) => {
  if (snap.exists()) {
    const data = snap.val();
    const { lat, lng } = data;
    if (map && marker) {
      marker.setPosition({ lat, lng });
      map.setCenter({ lat, lng });
    } else {
      initMap(lat, lng);
    }
  }
});

// ✅ 설정값 구독 (줌/투명도/크기)
onValue(ref(db, "location/settings"), (snap) => {
  if (snap.exists() && map) {
    const s = snap.val();
    if (s.mapLevel) map.setZoom(s.mapLevel);
    if (marker) {
      marker.setOpacity(s.opacity ?? 1);
      marker.setIcon({
        path: google.maps.SymbolPath.CIRCLE,
        scale: (s.size ?? 100) / 10,
        fillColor: "red",
        fillOpacity: s.opacity ?? 1,
        strokeWeight: 1
      });
    }
  }
});

// ✅ 테마 구독
onValue(ref(db, "location/theme"), (snap) => {
  if (snap.exists() && map) {
    const theme = snap.val().value;
    if (theme === "dark") {
      map.setOptions({ styles: darkStyle });
    } else {
      map.setOptions({ styles: [] }); // 기본 라이트
    }
  }
});

window.onload = () => initMap();
</script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  #map {
    height: 100%;
    width: 100%;
  }
</style>
</head>
<body>
  <div id="map"></div>
</body>
</html>

